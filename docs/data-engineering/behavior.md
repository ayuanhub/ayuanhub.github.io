
---
sidebar_position: 3
title: 行為洞察
---

# 行為洞察

| 業務代碼 | 欄位名稱          | 欄位說明         | MView / View | 備註  |
|------|---------------|--------------|--------------|-----|
| TX   | TX_CAR_YEAR   | 最近一期牌照稅繳納年度  |              |[連結](#最近一期牌照稅繳納年度最近一期牌照稅車輛數最近一期最大牌照稅CC數最近一期燃料稅繳納年度最近一期燃料稅車輛數最近一期最大燃料稅CC數最近一期房屋稅繳納年度最近一期房屋稅筆數最近一期房屋稅總金額最近一期地價稅繳納年度最近一期地價稅筆數最近一期地價稅總金額最近一期綜所稅繳納年度最近一期綜所稅總金額)     |
| TX   | TX_CAR_CNT    | 最近一期牌照稅車輛數   |              |[連結](#最近一期牌照稅繳納年度最近一期牌照稅車輛數最近一期最大牌照稅CC數最近一期燃料稅繳納年度最近一期燃料稅車輛數最近一期最大燃料稅CC數最近一期房屋稅繳納年度最近一期房屋稅筆數最近一期房屋稅總金額最近一期地價稅繳納年度最近一期地價稅筆數最近一期地價稅總金額最近一期綜所稅繳納年度最近一期綜所稅總金額)     |
| TX   | TX_MAXCARCC   | 最近一期最大牌照稅CC數 |              |[連結](#最近一期牌照稅繳納年度最近一期牌照稅車輛數最近一期最大牌照稅CC數最近一期燃料稅繳納年度最近一期燃料稅車輛數最近一期最大燃料稅CC數最近一期房屋稅繳納年度最近一期房屋稅筆數最近一期房屋稅總金額最近一期地價稅繳納年度最近一期地價稅筆數最近一期地價稅總金額最近一期綜所稅繳納年度最近一期綜所稅總金額)     |
| TX   | TX_FUEL_YEAR  | 最近一期燃料稅繳納年度  |              |[連結](#最近一期牌照稅繳納年度最近一期牌照稅車輛數最近一期最大牌照稅CC數最近一期燃料稅繳納年度最近一期燃料稅車輛數最近一期最大燃料稅CC數最近一期房屋稅繳納年度最近一期房屋稅筆數最近一期房屋稅總金額最近一期地價稅繳納年度最近一期地價稅筆數最近一期地價稅總金額最近一期綜所稅繳納年度最近一期綜所稅總金額)     |
| TX   | TX_FUEL_CNT   | 最近一期燃料稅車輛數   |              |[連結](#最近一期牌照稅繳納年度最近一期牌照稅車輛數最近一期最大牌照稅CC數最近一期燃料稅繳納年度最近一期燃料稅車輛數最近一期最大燃料稅CC數最近一期房屋稅繳納年度最近一期房屋稅筆數最近一期房屋稅總金額最近一期地價稅繳納年度最近一期地價稅筆數最近一期地價稅總金額最近一期綜所稅繳納年度最近一期綜所稅總金額)     |
| TX   | TX_MAXFUELCC  | 最近一期最大燃料稅CC數 |              |[連結](#最近一期牌照稅繳納年度最近一期牌照稅車輛數最近一期最大牌照稅CC數最近一期燃料稅繳納年度最近一期燃料稅車輛數最近一期最大燃料稅CC數最近一期房屋稅繳納年度最近一期房屋稅筆數最近一期房屋稅總金額最近一期地價稅繳納年度最近一期地價稅筆數最近一期地價稅總金額最近一期綜所稅繳納年度最近一期綜所稅總金額)     |
| TX   | TX_HOUSE_YEAR | 最近一期房屋稅繳納年度  |              |[連結](#最近一期牌照稅繳納年度最近一期牌照稅車輛數最近一期最大牌照稅CC數最近一期燃料稅繳納年度最近一期燃料稅車輛數最近一期最大燃料稅CC數最近一期房屋稅繳納年度最近一期房屋稅筆數最近一期房屋稅總金額最近一期地價稅繳納年度最近一期地價稅筆數最近一期地價稅總金額最近一期綜所稅繳納年度最近一期綜所稅總金額)     |
| TX   | TX_HOUSE_CNT  | 最近一期房屋稅筆數    |              |[連結](#最近一期牌照稅繳納年度最近一期牌照稅車輛數最近一期最大牌照稅CC數最近一期燃料稅繳納年度最近一期燃料稅車輛數最近一期最大燃料稅CC數最近一期房屋稅繳納年度最近一期房屋稅筆數最近一期房屋稅總金額最近一期地價稅繳納年度最近一期地價稅筆數最近一期地價稅總金額最近一期綜所稅繳納年度最近一期綜所稅總金額)     |
| TX   | TX_HOUSE_AMT  | 最近一期房屋稅總金額   |              |[連結](#最近一期牌照稅繳納年度最近一期牌照稅車輛數最近一期最大牌照稅CC數最近一期燃料稅繳納年度最近一期燃料稅車輛數最近一期最大燃料稅CC數最近一期房屋稅繳納年度最近一期房屋稅筆數最近一期房屋稅總金額最近一期地價稅繳納年度最近一期地價稅筆數最近一期地價稅總金額最近一期綜所稅繳納年度最近一期綜所稅總金額)     |
| TX   | TX_LAND_YEAR  | 最近一期地價稅繳納年度  |              |[連結](#最近一期牌照稅繳納年度最近一期牌照稅車輛數最近一期最大牌照稅CC數最近一期燃料稅繳納年度最近一期燃料稅車輛數最近一期最大燃料稅CC數最近一期房屋稅繳納年度最近一期房屋稅筆數最近一期房屋稅總金額最近一期地價稅繳納年度最近一期地價稅筆數最近一期地價稅總金額最近一期綜所稅繳納年度最近一期綜所稅總金額)     |
| TX   | TX_LAND_CNT   | 最近一期地價稅筆數    |              |[連結](#最近一期牌照稅繳納年度最近一期牌照稅車輛數最近一期最大牌照稅CC數最近一期燃料稅繳納年度最近一期燃料稅車輛數最近一期最大燃料稅CC數最近一期房屋稅繳納年度最近一期房屋稅筆數最近一期房屋稅總金額最近一期地價稅繳納年度最近一期地價稅筆數最近一期地價稅總金額最近一期綜所稅繳納年度最近一期綜所稅總金額)     |
| TX   | TX_LAND_AMT   | 最近一期地價稅總金額   |              |[連結](#最近一期牌照稅繳納年度最近一期牌照稅車輛數最近一期最大牌照稅CC數最近一期燃料稅繳納年度最近一期燃料稅車輛數最近一期最大燃料稅CC數最近一期房屋稅繳納年度最近一期房屋稅筆數最近一期房屋稅總金額最近一期地價稅繳納年度最近一期地價稅筆數最近一期地價稅總金額最近一期綜所稅繳納年度最近一期綜所稅總金額)     |
| TX   | TX_TAX_YEAR   | 最近一期綜所稅繳納年度   |              |[連結](#最近一期牌照稅繳納年度最近一期牌照稅車輛數最近一期最大牌照稅CC數最近一期燃料稅繳納年度最近一期燃料稅車輛數最近一期最大燃料稅CC數最近一期房屋稅繳納年度最近一期房屋稅筆數最近一期房屋稅總金額最近一期地價稅繳納年度最近一期地價稅筆數最近一期地價稅總金額最近一期綜所稅繳納年度最近一期綜所稅總金額)     |
| TX   | TX_TAX_AMT    | 最近一期綜所稅總金額   |              |[連結](#最近一期牌照稅繳納年度最近一期牌照稅車輛數最近一期最大牌照稅CC數最近一期燃料稅繳納年度最近一期燃料稅車輛數最近一期最大燃料稅CC數最近一期房屋稅繳納年度最近一期房屋稅筆數最近一期房屋稅總金額最近一期地價稅繳納年度最近一期地價稅筆數最近一期地價稅總金額最近一期綜所稅繳納年度最近一期綜所稅總金額)     |

### 最近一期牌照稅繳納年度、最近一期牌照稅車輛數、最近一期最大牌照稅CC數、最近一期燃料稅繳納年度、最近一期燃料稅車輛數、最近一期最大燃料稅CC數、最近一期房屋稅繳納年度、最近一期房屋稅筆數、最近一期房屋稅總金額、最近一期地價稅繳納年度、最近一期地價稅筆數、最近一期地價稅總金額、最近一期綜所稅繳納年度、最近一期綜所稅總金額

```sql title="" showLineNumbers
-- 牌照稅
WITH license AS (
    SELECT
        1 AS flag,
        element_at(
            map(
                array [1620, 2160, 4320, 7120, 11230, 15210, 28220, 46170, 69690, 117000, 151200],
                array ['251-500','501-600','601-1200','1201-1800','1801-2400','2401-3000','3001-4200','4201-5400','5401-6600','6601-7800','7801以上']
            ),
            STMD_P_AMT
        ) AS cc,
        year(STMD_PUR_D) AS "year_STMD_PUR_D",
        *
    FROM
        ods_d_jcsstmd
    WHERE
        stmd_des_c LIKE '%使用牌照稅%' -- 自用車牌照稅金額
        AND STMD_P_AMT IN (
            1620,
            2160,
            4320,
            7120,
            11230,
            15210,
            28220,
            46170,
            69690,
            117000,
            151200
        )
),
-- 最近一期牌照稅年度
license_group AS (
    SELECT
        stmd_id,
        MAX (year(STMD_PUR_D)) AS "year_max_STMD_PUR_D"
    FROM
        ods_d_jcsstmd
    WHERE
        stmd_des_c LIKE '%使用牌照稅%' -- 自用車牌照稅金額
        AND STMD_P_AMT IN (
            1620,
            2160,
            4320,
            7120,
            11230,
            15210,
            28220,
            46170,
            69690,
            117000,
            151200
        )
    GROUP BY
        stmd_id
),
-- 燃料稅
fuel AS (
    SELECT
        2 AS flag,
        -- 以手續費回推
        element_at(
            map(
                array [21,28,43,48,61,72,86,98,112,121,130,139,149,157],
                array ['251-500','501-600','601-1200','1201-1800','1801-2400','2401-3000','3001-3600','3601-4200','4201-4800','4801-5400','5401-6000','6001-6600','6601-7200','7201-8000']
            ),
            STMD_P_AMT
        ) AS cc,
        year(STMD_PUR_D) AS "year_STMD_PUR_D",
        *
    FROM
        ods_d_jcsstmd
    WHERE
        stmd_des_c LIKE '%燃料稅%'
        AND STMD_P_AMT IN (21, 28, 43, 48, 61, 72, 86, 98, 112, 121, 130, 139, 149, 157)
),
-- 最近一期燃料稅年度
fuel_group AS (
    SELECT
        stmd_id,
        MAX (year(STMD_PUR_D)) AS "year_max_STMD_PUR_D"
    FROM
        ods_d_jcsstmd
    WHERE
        stmd_des_c LIKE '%燃料稅%'
        AND STMD_P_AMT IN (21, 28, 43, 48, 61, 72, 86, 98, 112, 121, 130, 139, 149, 157)
    GROUP BY
        stmd_id
),
-- 房屋稅
house AS (
    SELECT
        3 AS flag,
        NULL AS cc,
        year(STMD_PUR_D) AS "year_STMD_PUR_D",
        *
    FROM
        ods_d_jcsstmd -- 因髒資料，未抓112年資料，無法區分出分期付款
    WHERE
        TRIM(stmd_des_c) LIKE ('%年房屋稅')
        OR TRIM(stmd_des_c) LIKE ('%年房屋稅　　%')
),
-- 最近一期房屋稅年度
house_group AS (
    SELECT
        stmd_id,
        MAX (year(STMD_PUR_D)) AS "year_max_STMD_PUR_D"
    FROM
        ods_d_jcsstmd -- 因資料面有兩種資料pattern
    WHERE
        TRIM(stmd_des_c) LIKE ('%年房屋稅')
        OR TRIM(stmd_des_c) LIKE ('%年房屋稅　　%')
    GROUP BY
        stmd_id
),
-- 地價稅
land AS (
    SELECT
        4 AS flag,
        NULL AS cc,
        year(STMD_PUR_D) AS "year_STMD_PUR_D",
        *
    FROM
        ods_d_jcsstmd -- 因資料面有兩種資料pattern
    WHERE
        TRIM(stmd_des_c) LIKE ('%年地價稅')
        OR TRIM(stmd_des_c) LIKE ('%年地價稅　　%')
),
-- 最近一期地價稅年度
land_group AS (
    SELECT
        stmd_id,
        MAX (year(STMD_PUR_D)) AS "year_max_STMD_PUR_D"
    FROM
        ods_d_jcsstmd -- 因資料面有兩種資料pattern
    WHERE
        TRIM(stmd_des_c) LIKE ('%年地價稅')
        OR TRIM(stmd_des_c) LIKE ('%年地價稅　　%')
    GROUP BY
        stmd_id
),
-- 綜所稅
tax AS (
    SELECT
        5 AS flag,
        NULL AS cc,
        year(STMD_PUR_D) AS "year_STMD_PUR_D",
        *
    FROM
        ods_d_jcsstmd
    WHERE
        TRIM(stmd_des_c) LIKE ('%年綜所稅款')
),
-- 最近一期綜所稅年度
tax_group AS (
    SELECT
        stmd_id,
        MAX (year(STMD_PUR_D)) AS "year_max_STMD_PUR_D"
    FROM
        ods_d_jcsstmd -- 因資料面有兩種資料pattern
    WHERE
        TRIM(stmd_des_c) LIKE ('%年綜所稅款')
    GROUP BY
        stmd_id
)
SELECT
    -- 身分證字號
    TRIM(AA.stmd_id) AS "CUST_ID",
    -- 最近一期牌照稅繳納年度
    MAX_BY(
        AA.year_stmd_pur_d,
        IF (AA.flag = 1, AA.year_stmd_pur_d)
    ) AS "TX_CAR_YEAR",
    -- 最近一期牌照稅車輛數
    SUM(IF(AA.flag = 1, 1, 0)) AS "TX_CAR_CNT",
    -- 最近一期最大牌照稅CC數
    MAX_BY(AA.cc, IF(AA.flag = 1, AA.STMD_P_AMT)) AS "TX_MAXCARCC",
    -- 最近一期燃料稅繳納年度
    MAX_BY(
        AA.year_stmd_pur_d,
        IF (AA.flag = 2, AA.year_stmd_pur_d)
    ) AS "TX_FUEL_YEAR",
    -- 最近一期燃料稅車輛數
    SUM(IF(AA.flag = 2, 1, 0)) AS "TX_FUEL_CNT",
    -- 最近一期最大燃料稅CC數
    MAX_BY(AA.cc, IF(AA.flag = 2, AA.STMD_P_AMT)) AS "TX_MAXFUELCC",
    -- 最近一期房屋稅繳納年度
    MAX_BY(
        AA.year_stmd_pur_d,
        IF (AA.flag = 3, AA.year_stmd_pur_d)
    ) AS "TX_HOUSE_YEAR",
    -- 最近一期房屋稅筆數
    SUM(IF(AA.flag = 3, 1, 0)) AS "TX_HOUSE_CNT",
    -- 最近一期房屋稅總金額
    SUM(IF(AA.flag = 3, AA.STMD_P_AMT, 0)) AS "TX_HOUSE_AMT",
    -- 最近一期地價稅繳納年度
    MAX_BY(
        AA.year_stmd_pur_d,
        IF (AA.flag = 4, AA.year_stmd_pur_d)
    ) AS "TX_LAND_YEAR",
    -- 最近一期地價稅筆數
    SUM(IF(AA.flag = 4, 1, 0)) AS "TX_LAND_CNT",
    -- 最近一期地價稅總金額
    SUM(IF(AA.flag = 4, AA.STMD_P_AMT, 0)) AS "TX_LAND_AMT",
    -- 最近一期綜所稅繳納年度
    MAX_BY(
        AA.year_stmd_pur_d,
        IF (AA.flag = 5, AA.year_stmd_pur_d)
    ) AS "TX_TAX_YEAR",
    -- 最近一期綜所稅總金額
    SUM(IF(AA.flag = 5, AA.STMD_P_AMT, 0)) AS "TX_TAX_AMT"
FROM
    (
        SELECT
            flag,
            cc,
            year_stmd_pur_d,
            A.stmd_id,
            stmd_des_c,
            stmd_p_amt
        FROM
            license A
            INNER JOIN license_group B ON (
                A.stmd_id = B.stmd_id
                AND A.year_STMD_PUR_D = B.year_max_STMD_PUR_D
            )
        UNION
        SELECT
            flag,
            cc,
            year_stmd_pur_d,
            C.stmd_id,
            stmd_des_c,
            stmd_p_amt
        FROM
            fuel C
            INNER JOIN fuel_group D ON (
                C.stmd_id = D.stmd_id
                AND C.year_STMD_PUR_D = D.year_max_STMD_PUR_D
            )
        UNION
        SELECT
            flag,
            cc,
            year_stmd_pur_d,
            E.stmd_id,
            stmd_des_c,
            stmd_p_amt
        FROM
            house E
            INNER JOIN house_group F ON (
                E.stmd_id = F.stmd_id
                AND E.year_STMD_PUR_D = F.year_max_STMD_PUR_D
            )
        UNION
        SELECT
            flag,
            cc,
            year_stmd_pur_d,
            G.stmd_id,
            stmd_des_c,
            stmd_p_amt
        FROM
            land G
            INNER JOIN land_group H ON (
                G.stmd_id = H.stmd_id
                AND G.year_STMD_PUR_D = H.year_max_STMD_PUR_D
            )
        UNION
        SELECT
            flag,
            cc,
            year_stmd_pur_d,
            I.stmd_id,
            stmd_des_c,
            stmd_p_amt
        FROM
            tax I
            INNER JOIN tax_group J ON (
                I.stmd_id = J.stmd_id
                AND I.year_STMD_PUR_D = J.year_max_STMD_PUR_D
            )
    ) AS AA
GROUP BY
    AA.stmd_id
```